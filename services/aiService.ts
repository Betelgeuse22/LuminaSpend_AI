import Groq from "groq-sdk";
import { Receipt, Category, SpendingInsight } from "../types";
import { supabase } from "@/lib/supabase";

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Groq —á–µ—Ä–µ–∑ Vite env
const groq = new Groq({ 
  apiKey: import.meta.env.VITE_GROQ_API_KEY,
  dangerouslyAllowBrowser: true // –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø—É—Å–∫ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è —É—á–µ–±–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
});

const SYSTEM_PROMPT = `
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É —á–µ–∫–æ–≤ (OCR + –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤).
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∏–∑–≤–ª–µ—á—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞ —á–µ–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.

========================
üìå –û–°–ù–û–í–ù–´–ï –ü–†–ê–í–ò–õ–ê
========================
1. –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–π –°–¢–†–û–ì–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.
2. –ù–µ –¥–æ–±–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç –≤–Ω–µ JSON.
3. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π null (–Ω–æ –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π).
4. –ù–∞–∑–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –æ—Å—Ç–∞–≤–ª—è–π –í –û–†–ò–ì–ò–ù–ê–õ–ï (–∫–∞–∫ –≤ —á–µ–∫–µ, –±–µ–∑ –ø–µ—Ä–µ–≤–æ–¥–∞).

========================
üì¶ –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –¢–û–í–ê–†–û–í
========================
–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –∏–∑–≤–ª–µ–∫–∏:
- name: –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
- category: –æ–¥–Ω–∞ –∏–∑ —Å—Ç—Ä–æ–≥–æ –∑–∞–¥–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π (—Å–º. –Ω–∏–∂–µ)
- quantity: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—á–∏—Å–ª–æ)
- price: –∏—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ –ó–ê –í–°–Å –ö–û–õ–ò–ß–ï–°–¢–í–û (–Ω–µ –∑–∞ 1 —à—Ç!)

üìå –ü–†–ê–í–ò–õ–ê –ö–û–õ–ò–ß–ï–°–¢–í–ê:
- "3 Stk x 0.99" ‚Üí quantity: 3, price: 2.97
- "2 x 1.50" ‚Üí quantity: 2, price: 3.00
- "4 —à—Ç" ‚Üí quantity: 4
- –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Üí quantity: 1

========================
üß† –ö–ê–¢–ï–ì–û–†–ò–ó–ê–¶–ò–Ø (–û–ß–ï–ù–¨ –í–ê–ñ–ù–û)
========================

–ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —ç—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:

- Sweets (—Å–ª–∞–¥–æ—Å—Ç–∏)
- Drinks (–Ω–∞–ø–∏—Ç–∫–∏)
- Fruits (—Ñ—Ä—É–∫—Ç—ã)
- Vegetables (–æ–≤–æ—â–∏)
- Meat (–º—è—Å–æ)
- Fish (—Ä—ã–±–∞)
- Dairy (–º–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã)
- Groceries (–±–∞–∫–∞–ª–µ—è)
- ReadyFood (–≥–æ—Ç–æ–≤–∞—è –µ–¥–∞)
- Household (–±—ã—Ç–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã)
- Other (–ø—Ä–æ—á–µ–µ)

üìå –ü–†–ê–í–ò–õ–ê –ö–ê–¢–ï–ì–û–†–ò–ó–ê–¶–ò–ò:

Sweets:
- —à–æ–∫–æ–ª–∞–¥, –∫–æ–Ω—Ñ–µ—Ç—ã, –ø–µ—á–µ–Ω—å–µ, –¥–µ—Å–µ—Ä—Ç—ã, –º–æ—Ä–æ–∂–µ–Ω–æ–µ, –≤–∞—Ñ–ª–∏
- –ø—Ä–∏–º–µ—Ä—ã: "Schokolade", "Kinder Bueno", "Keks"

Drinks:
- –≤–æ–¥–∞, —Å–æ–∫–∏, –≥–∞–∑–∏—Ä–æ–≤–∫–∞, –ø–∏–≤–æ, –∞–ª–∫–æ–≥–æ–ª—å, –∫–æ—Ñ–µ, —á–∞–π
- –ø—Ä–∏–º–µ—Ä—ã: "Cola", "Wasser", "Bier", "Saft"

Fruits:
- —Å–≤–µ–∂–∏–µ —Ñ—Ä—É–∫—Ç—ã
- –ø—Ä–∏–º–µ—Ä—ã: "Banane", "Apfel", "Orange"

Vegetables:
- –æ–≤–æ—â–∏
- –ø—Ä–∏–º–µ—Ä—ã: "Tomaten", "Kartoffeln", "Gurke"

Meat:
- —Å—ã—Ä–æ–µ –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –º—è—Å–æ
- –ø—Ä–∏–º–µ—Ä—ã: "H√§hnchen", "Rindfleisch", "Wurst"

Fish:
- —Ä—ã–±–∞ –∏ –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã
- –ø—Ä–∏–º–µ—Ä—ã: "Lachs", "Thunfisch"

Dairy:
- –º–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
- –ø—Ä–∏–º–µ—Ä—ã: "Milch", "K√§se", "Joghurt", "Butter"

Groceries:
- –∫—Ä—É–ø—ã, –º–∞–∫–∞—Ä–æ–Ω—ã, —Ö–ª–µ–±, —Å–ø–µ—Ü–∏–∏, –∫–æ–Ω—Å–µ—Ä–≤—ã
- –ø—Ä–∏–º–µ—Ä—ã: "Reis", "Nudeln", "Brot", "Mehl"

ReadyFood:
- –≥–æ—Ç–æ–≤–∞—è –µ–¥–∞, –ø–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç—ã, —Ñ–∞—Å—Ç—Ñ—É–¥
- –ø—Ä–∏–º–µ—Ä—ã: "Pizza", "Sandwich", "Fertiggericht", "Sushi Box"

Household:
- –±—ã—Ç–æ–≤–∞—è —Ö–∏–º–∏—è, —Ç–æ–≤–∞—Ä—ã –¥–ª—è –¥–æ–º–∞
- –ø—Ä–∏–º–µ—Ä—ã: "Waschmittel", "Toilettenpapier", "Sp√ºlmittel"

Other:
- –≤—Å—ë, —á—Ç–æ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –Ω–∏ –ø–æ–¥ –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é

üìå –ü–†–ò–û–†–ò–¢–ï–¢–´:
- –ï—Å–ª–∏ –ø—Ä–æ–¥—É–∫—Ç –º–æ–∂–Ω–æ –æ—Ç–Ω–µ—Å—Ç–∏ –∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º ‚Üí –≤—ã–±–∏—Ä–∞–π –Ω–∞–∏–±–æ–ª–µ–µ –æ—á–µ–≤–∏–¥–Ω—É—é.
- –ù–∞–ø—Ä–∏–º–µ—Ä:
  - "Chocolate Milk" ‚Üí Dairy (–ù–ï Sweets)
  - "Fruit Yogurt" ‚Üí Dairy
  - "Ice Cream" ‚Üí Sweets
  - "Beer" ‚Üí Drinks

========================
üìä –§–ò–ù–ê–õ–¨–ù–´–ô JSON
========================

{
  "storeName": "–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞",
  "date": "–ì–ì–ì–ì-–ú–ú-–î–î",
  "totalAmount": —á–∏—Å–ª–æ,
  "currency": "EUR",
  "items": [
    {
      "name": "–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ",
      "category": "–æ–¥–Ω–∞ –∏–∑ Category",
      "quantity": —á–∏—Å–ª–æ,
      "price": —á–∏—Å–ª–æ
    }
  ],
  "aiSummary": "–ö—Ä–∞—Ç–∫–∏–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∏–Ω—Å–∞–π—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)"
}

========================
üí° AI SUMMARY
========================
- –ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- –ö—Ä–∞—Ç–∫–æ (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
- –ü—Ä–∏–º–µ—Ä:
  "–ë–æ–ª—å—à–∞—è —á–∞—Å—Ç—å —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø—Ä–∏—à–ª–∞—Å—å –Ω–∞ –Ω–∞–ø–∏—Ç–∫–∏ –∏ —Å–ª–∞–¥–æ—Å—Ç–∏. –ú–æ–∂–Ω–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Ç—Ä–∞—Ç—ã –∑–∞ —Å—á—ë—Ç —É–º–µ–Ω—å—à–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏ —Å–Ω–µ–∫–æ–≤."

========================
‚ö†Ô∏è –í–ê–ñ–ù–û
========================
- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ç–æ–≤–∞—Ä—ã
- –ù–ï –æ–±—ä–µ–¥–∏–Ω—è–π —Å—Ç—Ä–æ–∫–∏ (–∫–∞–∂–¥–∞—è –ø–æ–∑–∏—Ü–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ)
- –ù–ï –ø–µ—Ä–µ–≤–æ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏—è
- –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¢–û–õ–¨–ö–û –∏–∑ —Å–ø–∏—Å–∫–∞
`;


export const parseReceiptImage = async (base64Image: string): Promise<Partial<Receipt>> => {
  try {
    const cleanBase64 = base64Image.split(',')[1] || base64Image;

    const completion = await groq.chat.completions.create({
      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ Llama 4 Scout (–∞–∫—Ç—É–∞–ª—å–Ω–∞—è Vision-–º–æ–¥–µ–ª—å)
      model: "meta-llama/llama-4-scout-17b-16e-instruct", 
      messages: [
        {
          role: "user",
          content: [
            { type: "text", text: SYSTEM_PROMPT },
            {
              type: "image_url",
              image_url: { url: `data:image/jpeg;base64,${cleanBase64}` },
            },
          ],
        },
      ],
      response_format: { type: "json_object" },
    });

    const content = completion.choices[0]?.message?.content;
    if (!content) throw new Error("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò");

    return JSON.parse(content);
  } catch (error) {
    console.error("Groq OCR Error:", error);
    // –¢–æ—á–∫–∞ —Ä–æ—Å—Ç–∞: –ï—Å–ª–∏ Maverick —Ç–æ–∂–µ –Ω–µ –≤–∏–¥–µ–Ω, –ø–æ–ø—Ä–æ–±—É–π llama-3.2-90b-vision-preview (–µ—Å–ª–∏ –æ–Ω–∞ –µ—â–µ –∂–∏–≤–∞)
    throw error;
  }
};

export const generateSavingsAdvice = async (receipts: Receipt[]): Promise<SpendingInsight[]> => {
  if (receipts.length === 0) return [];

  // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–≤–æ–¥–∫—É —Ç—Ä–∞—Ç –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ò–ò
  const summary = receipts
    .map(r => `${r.date}: ${r.storeName} - ${r.totalAmount} ${r.currency}`)
    .join('\n');

  try {
    const completion = await groq.chat.completions.create({
      model: "llama-3.3-70b-versatile", 
      messages: [
        { 
          role: "system", 
          // –£—Ç–æ—á–Ω—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é: –ø—Ä–æ—Å–∏–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á "insights"
          content: `–¢—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–∞—Å—Ö–æ–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. 
          –í–µ—Ä–Ω–∏ JSON –æ–±—ä–µ–∫—Ç —Å –∫–ª—é—á–æ–º "insights", –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∞—Å—Å–∏–≤ –∏–∑ 3 –æ–±—ä–µ–∫—Ç–æ–≤.
          –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±—ä–µ–∫—Ç–∞: { "title": string, "description": string, "type": "warning" | "savings" | "trend", "impact": string }.
          –Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π.` 
        },
        { 
          role: "user", 
          content: `–î–∞–π —Å–æ–≤–µ—Ç—ã –ø–æ —ç–∫–æ–Ω–æ–º–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–∏—Ö —á–µ–∫–æ–≤:\n${summary}` 
        },
      ],
      // –≠—Ç–æ –ø–æ–ª–µ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç Groq –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å JSON
      response_format: { type: "json_object" },
    });

    const rawContent = completion.choices[0]?.message?.content || '{}';
    const parsedData = JSON.parse(rawContent);

    // –õ–û–ì–ò–ö–ê –†–ê–°–ü–ê–ö–û–í–ö–ò:
    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á "insights"
    if (parsedData.insights && Array.isArray(parsedData.insights)) {
      return parsedData.insights;
    }

    // 2. –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: –µ—Å–ª–∏ –ò–ò –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –¥—Ä—É–≥–æ–µ –∏–º—è –∫–ª—é—á–∞, –∏—â–µ–º –ª—é–±–æ–π –º–∞—Å—Å–∏–≤ –≤–Ω—É—Ç—Ä–∏
    const anyArray = Object.values(parsedData).find(val => Array.isArray(val));
    if (Array.isArray(anyArray)) {
      return anyArray as SpendingInsight[];
    }

    // 3. –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤, —á—Ç–æ–±—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —É–ø–∞–ª–æ
    console.warn("AI –Ω–µ –≤–µ—Ä–Ω—É–ª –º–∞—Å—Å–∏–≤ —Å–æ–≤–µ—Ç–æ–≤ –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ", parsedData);
    return [];

  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–≤–µ—Ç–æ–≤ Groq:", e);
    return [];
  }
};

export const deleteReceiptFromDb = async (id: string): Promise<boolean> => {
  try {
    const { error } = await supabase
      .from('receipts')
      .delete()
      .eq('id', id);

    if (error) throw error;
    return true;
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–µ–∫–∞:", error);
    return false;
  }
};